// Prisma Schema for Habit Tracker
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String?

  // Preferences
  stepGoal     Int      @default(10000)
  reminderTime String   @default("20:00") // HH:MM format
  timezone     String   @default("UTC")
  theme        String   @default("light") // 'light' or 'dark'

  // Status flags
  isEmailVerified Boolean @default(false)
  isActive        Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  habits            Habit[]
  completions       Completion[]
  badges            UserBadge[]
  stepData          StepData[]
  notificationTokens NotificationToken[]

  @@map("users")
}

// Habit Model
model Habit {
  id        String   @id @default(uuid())
  userId    String
  title     String
  monthlyGoal Int     @default(20) // 1-31 days per month
  color     String   @default("#6C63FF") // Hex color
  icon      String?  // Emoji or icon name

  // Notification settings
  notificationsEnabled Boolean @default(false)
  reminderTime        String? // HH:MM format

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime? // Soft delete

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions Completion[]

  @@index([userId])
  @@index([userId, archivedAt])
  @@map("habits")
}

// Completion Model
model Completion {
  id          String   @id @default(uuid())
  habitId     String
  userId      String
  date        DateTime @db.Date // Just the date (YYYY-MM-DD)
  completedAt DateTime @default(now()) // Full timestamp

  // Relations
  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensure one completion per habit per day
  @@unique([habitId, date])
  @@index([userId, date])
  @@index([habitId, date])
  @@map("completions")
}

// Badge Model (Badge Definitions)
model Badge {
  id          String   @id @default(uuid())
  name        String   @unique            // "21-Day Warrior"
  description String                      // "Complete habit 21 days in a row"
  type        String                      // 'streak' | 'completion' | 'step' | 'special' | 'volume'
  tier        String                      // 'bronze' | 'silver' | 'gold' | 'platinum'
  requirement Int                         // 21, 45, 100, etc.
  iconName    String                      // 'fire', 'trophy', 'star'

  // Relations
  userBadges  UserBadge[]

  @@map("badges")
}

// UserBadge Model (User's Earned Badges)
model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  habitId   String?                       // Optional: which habit earned this badge
  earnedAt  DateTime @default(now())

  @@unique([userId, badgeId])            // Can't earn same badge twice
  @@index([userId])
  @@map("user_badges")
}

// StepData Model (Daily Step Counts)
model StepData {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date          // Just the date (2026-01-18)
  steps         Int                        // Number of steps
  distance      Float                      // Kilometers walked
  calories      Int?                       // Estimated calories burned
  activeMinutes Int?                       // Minutes of activity
  source        String   @default("manual") // 'pedometer' | 'manual'

  @@unique([userId, date])                // One record per user per day
  @@index([userId, date])
  @@map("step_data")
}

// NotificationToken Model (Push Notification Tokens)
model NotificationToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique              // Expo push token
  deviceId  String?                       // Device identifier
  platform  String                        // 'ios' | 'android'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("notification_tokens")
}
